version: "3.8"

services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "3000:8080" # Host:Container
    volumes:
      - open-webui:/app/backend/data
    environment:
      # Ollama Configuration (if running locally)
      - OLLAMA_BASE_URL=http://host.docker.internal:11434

      # OpenAI API Configuration (uncomment if using OpenAI instead of Ollama)
      # - OPENAI_API_KEY=your_openai_api_key_here

      # Other optional environment variables
      # - WEBUI_NAME=Open WebUI
      # - DEFAULT_USER_ROLE=pending
      # - ENABLE_SIGNUP=true
      # - ENABLE_LOGIN_FORM=true

      # Offline mode (set to 1 if running in offline environment)
      # - HF_HUB_OFFLINE=1

    extra_hosts:
      # This allows the container to access Ollama running on the host
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - webui-network

    # Uncomment the following lines if you need GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # Optional: Include Ollama service if you want to run it in the same compose stack
  # Uncomment this section if you want to run Ollama alongside Open WebUI
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: ollama
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama:/root/.ollama
  #   restart: unless-stopped
  #
  #   # Uncomment for GPU support in Ollama
  #   # deploy:
  #   #   resources:
  #   #     reservations:
  #   #       devices:
  #   #         - driver: nvidia
  #   #           count: all
  #   #           capabilities: [gpu]

  # MCP Proxy Server - ref-tools (default)
  mcpo-ref:
    build:
      context: .
      dockerfile: Dockerfile.mcpo
    container_name: mcpo-ref
    ports:
      - "8001:8000" # Host:Container - ref-tools MCP proxy on port 8001
    environment:
      - MCP_SERVER_TYPE=ref
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
    restart: unless-stopped
    networks:
      - webui-network

  # MCP Proxy Server - GitHub
  # Note: Requires GITHUB_PERSONAL_ACCESS_TOKEN to be set
  mcpo-github:
    build:
      context: .
      dockerfile: Dockerfile.mcpo-github
    container_name: mcpo-github
    ports:
      - "8002:8000" # Host:Container - GitHub MCP proxy on port 8002
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
    volumes:
      # Mount Docker socket to allow running GitHub MCP server container
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - webui-network

  # MCP Proxy Server - Filesystem
  mcpo-filesystem:
    build:
      context: .
      dockerfile: Dockerfile.mcpo-filesystem
    container_name: mcpo-filesystem
    ports:
      - "8003:8000" # Host:Container - Filesystem MCP proxy on port 8003
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Paths inside container (mapped via volumes)
      - FILESYSTEM_DIRS=/data/sonr /data/ui /data/notes
    volumes:
      # Map host directories to container paths
      - /home/prad/code/github.com/sonr-io/sonr:/data/sonr:ro
      - /home/prad/code/github.com/go-sonr/ui:/data/ui:ro
      - /home/prad/Notes:/data/notes:ro
    restart: unless-stopped
    networks:
      - webui-network

  # MCP Proxy Server - Obsidian
  mcpo-obsidian:
    build:
      context: .
      dockerfile: Dockerfile.mcpo-obsidian
    container_name: mcpo-obsidian
    ports:
      - "8004:8000" # Host:Container - Obsidian MCP proxy on port 8004
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Obsidian configuration (using existing env vars)
      - OBSIDIAN_API_KEY=${OBSIDIAN_API_KEY}
      - OBSIDIAN_HOST=${OBSIDIAN_HOST}
      - OBSIDIAN_PORT=${OBSIDIAN_PORT}
    restart: unless-stopped
    networks:
      - webui-network

  # MCP Proxy Server - Context7
  mcpo-context7:
    build:
      context: .
      dockerfile: Dockerfile.mcpo-context7
    container_name: mcpo-context7
    ports:
      - "8005:8000" # Host:Container - Context7 MCP proxy on port 8005
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Context7 configuration (using existing env var)
      - CONTEXT7_API_KEY=${CONTEXT7_API_KEY}
      - CONTEXT7_URL=https://mcp.context7.com/mcp
    restart: unless-stopped
    networks:
      - webui-network

  # MCP Proxy Server - Sequential Thinking
  mcpo-sequentialthinking:
    build:
      context: .
      dockerfile: Dockerfile.mcpo-sequentialthinking
    container_name: mcpo-sequentialthinking
    ports:
      - "8006:8000" # Host:Container - Sequential Thinking MCP proxy on port 8006
    environment:
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      # Optional: Set to "true" to disable thought logging
      - DISABLE_THOUGHT_LOGGING=false
    restart: unless-stopped
    networks:
      - webui-network

  # Alternative: Run GitHub MCP using Docker socket (requires Docker access)
  # mcpo-github-docker:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.mcpo
  #   container_name: mcpo-github-docker
  #   ports:
  #     - "8002:8000"
  #   environment:
  #     - MCP_SERVER_TYPE=github
  #     - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
  #     - MCP_HOST=0.0.0.0
  #     - MCP_PORT=8000
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock # Mount Docker socket
  #   restart: unless-stopped
  #   networks:
  #     - webui-network

networks:
  webui-network:
    driver: bridge

volumes:
  open-webui:
    driver: local
  # Uncomment if using the Ollama service above
  # ollama:
  #   driver: local

# Alternative configurations (comment out the main service above and uncomment one of these):

# Configuration 1: Open WebUI with bundled Ollama (CPU only)
# services:
#   open-webui:
#     image: ghcr.io/open-webui/open-webui:ollama
#     container_name: open-webui-ollama
#     ports:
#       - "3000:8080"
#     volumes:
#       - ollama:/root/.ollama
#       - open-webui:/app/backend/data
#     restart: unless-stopped

# Configuration 2: Open WebUI with bundled Ollama (GPU enabled)
# services:
#   open-webui:
#     image: ghcr.io/open-webui/open-webui:ollama
#     container_name: open-webui-ollama-gpu
#     ports:
#       - "3000:8080"
#     volumes:
#       - ollama:/root/.ollama
#       - open-webui:/app/backend/data
#     restart: unless-stopped
#     deploy:
#       resources:
#         reservations:
#           devices:
#             - driver: nvidia
#               count: all
#               capabilities: [gpu]

# Configuration 3: Open WebUI with CUDA support (separate Ollama)
# services:
#   open-webui:
#     image: ghcr.io/open-webui/open-webui:cuda
#     container_name: open-webui-cuda
#     ports:
#       - "3000:8080"
#     volumes:
#       - open-webui:/app/backend/data
#     environment:
#       - OLLAMA_BASE_URL=http://host.docker.internal:11434
#     extra_hosts:
#       - "host.docker.internal:host-gateway"
#     restart: unless-stopped
#     deploy:
#       resources:
#         reservations:
#           devices:
#             - driver: nvidia
#               count: all
#               capabilities: [gpu]

# Configuration 4: OpenAI API only (no Ollama)
# services:
#   open-webui:
#     image: ghcr.io/open-webui/open-webui:main
#     container_name: open-webui-openai
#     ports:
#       - "3000:8080"
#     volumes:
#       - open-webui:/app/backend/data
#     environment:
#       - OPENAI_API_KEY=your_openai_api_key_here
#       # Optional: Add other OpenAI-compatible API endpoints
#       # - OPENAI_API_BASE_URL=https://api.openai.com/v1
#     restart: unless-stopped
