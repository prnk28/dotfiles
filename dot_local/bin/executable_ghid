#!/usr/bin/env bash
set -e

# Default Variables
GIT_ROOT=$(git rev-parse --show-toplevel)
GIT_WORK_TREE="$GIT_ROOT/.gitwork"

ISSUE=$(gh list-issues)
BRANCH_NAME=$(gh issue view $ISSUE | mods -R branch-namer)
GITWORK_DIR="$GIT_WORK_TREE/$BRANCH_NAME"

copy_issue_to_clipboard() {
  pbcopy <<< $ISSUE
}

create_worktree() {
  if [[ -d $GITWORK_DIR ]]; then
    gum log "Worktree already exists: $GITWORK_DIR"
    return 1
  fi
  git worktree add "$GITWORK_DIR" "$BRANCH_NAME"
  return 0
}

start_develop() {
  gh issue develop $ISSUE -n "$BRANCH_NAME"
  create_worktree
}

confirm_develop() {
  gum confirm "Start work on #$ISSUE on $BRANCH_NAME?" && start_develop || exit 1
}

sync_r2_claude() {
  cd $GITWORK_DIR
  rclone sync -P r2:claude .claude
}

main() {
  confirm_develop
  sync_r2_claude
  copy_issue_to_clipboard
}

main "$@"
