#!/usr/bin/env bash
set -e

SCOPES_FILE=".github/scopes.json"

# Check if scopes file exists
if [[ ! -f "$SCOPES_FILE" ]]; then
    echo "No scopes.json found - processing all changes..."

    # Check for staged files first
    staged_diff=$(git diff --cached)

    # If no staged files, stage all unstaged tracked files
    if [[ -z "$staged_diff" ]]; then
        git add -u
        staged_diff=$(git diff --cached)
    fi

    if [[ -z "$staged_diff" ]]; then
        echo "No changes found"
        exit 0
    fi

    # Generate commit message using mods
    echo "Generating commit message..."
    message=$(echo "$staged_diff" | mods -R write-commit)

    echo ""
    echo "Commit message:"
    echo "$message"
    echo ""

    # Confirm and commit
    if gum confirm "Commit all changes?"; then
        git commit -m "$message"
        echo "✓ Committed all changes"
    fi

    exit 0
fi

# Get all changed files (both staged and unstaged) and find their scopes
echo "Finding scopes with changes..."

# Combine staged and unstaged files
CHANGED_FILES=$( (git diff --cached --name-only; git diff --name-only) | sort -u)

SCOPES=$(echo "$CHANGED_FILES" | while read file; do
    [[ -z "$file" ]] && continue
    jq -r --arg f "$file" '.[] | select(.path as $p | $f | startswith($p)) | .scope' "$SCOPES_FILE"
done | sort -u)

if [[ -z "$SCOPES" ]]; then
    echo "No changes found"
    exit 0
fi

echo "Scopes with changes: $SCOPES"
echo ""

# Process each scope
for scope in $SCOPES; do
    echo "Processing scope: $scope"

    # Get the path for this scope
    scope_path=$(jq -r --arg scope "$scope" '.[] | select(.scope == $scope) | .path' "$SCOPES_FILE")

    if [[ -z "$scope_path" ]]; then
        echo "Warning: Could not find path for scope $scope"
        continue
    fi

    # Reset staging area
    git reset HEAD -- . 2>/dev/null || true

    echo "  Staging files in $scope_path..."

    # Get all changed files (staged and unstaged) in this scope's path
    # Use git status to catch all modified, added, deleted files
    scope_files=$(git status --porcelain | awk '{print $2}' | grep "^$scope_path" || true)

    if [[ -z "$scope_files" ]]; then
        echo "  No files found in $scope_path"
        continue
    fi

    echo "  Files to stage:"
    echo "$scope_files" | sed 's/^/    /'

    # Stage all files in this scope
    echo "$scope_files" | xargs -r git add 2>/dev/null || true

    # Get the diff for this scope
    diff=$(git diff --cached)

    if [[ -z "$diff" ]]; then
        echo "  No changes to commit for $scope"
        continue
    fi

    # Generate commit message using mods
    echo "  Generating commit message..."
    context="### Git Diff
$diff

### Scope
$scope"

    message=$(echo "$context" | mods -R write-commit)

    echo ""
    echo "Commit message:"
    echo "$message"
    echo ""

    # Confirm and commit
    if gum confirm "Commit changes for $scope?"; then
        git commit -m "$message"
        echo "✓ Committed changes for $scope"
    else
        echo "  Skipped $scope"
    fi

    echo ""
done

# Reset staging area at the end
git reset HEAD -- . 2>/dev/null || true

echo "Done!"
