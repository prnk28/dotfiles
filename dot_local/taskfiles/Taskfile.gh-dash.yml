# https://taskfile.dev
version: "3"
silent: true
vars:
  KVN: 3a872e35b85c49bb8f5fe753198b5848
tasks:
  default:
    cmds:
      - echo "new-issue - Create a new issue"
      - echo "start-issue - Start a new issue"
      - echo "open-pr - Open an existing issue"
  new-issue:
    desc: Create a new issue
    vars:
      REPO:
        sh: gh repo list sonr-io --json name --jq ".[].name" | gum filter --placeholder "Select a repo to create an issue in"
      CONTEXT:
        sh: gum write --placeholder "Enter a short context for the issue"
    cmds:
      - echo "{{.REPO}}:{{.CONTEXT}}" | mods -R issue-creator
  start-issue:
    desc: Start a new issue
    requires:
      vars: [NUMBER, PATH]
    dir: "{{.PATH}}"
    vars:
      DIR:
        sh: basename $(git rev-parse --show-toplevel)
      WORKTREE: "{{.DIR}}-{{.NUMBER}}"
    cmds:
      - echo "Creating branch to start issue {{.NUMBER}}..."
      - title=$(gh issue view {{.NUMBER}} | mods -R branch-namer); npx wrangler kv key put --namespace-id={{.KVN}} "$title" "{{.NUMBER}}"; gh issue develop {{.NUMBER}} -n $title -c
      - branch=$(git branch --show-current); git worktree add ../{{.WORKTREE}} $branch
      - tmux new-window -n "#{{.NUMBER}}" nvim
  current-issue:
    desc: Show the current issue
    requires:
      vars: [PATH]
    dir: "{{.PATH}}"
    cmds:
      - branch=$(git branch --show-current); gh issue view $(npx wrangler kv key get --namespace-id={{.KVN}} "$branch" --text) | glow -p
  open-pr:
    desc: Open an existing issue
    requires:
      vars: [NUMBER, PATH]
    dir: "{{.PATH}}"
    cmds:
      - echo "Currently not implemented"
