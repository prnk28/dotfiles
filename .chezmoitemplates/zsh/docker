
function compose-app-start() {
  local app_name="$1"
  if [[ -z "$app_name" ]]; then
    echo "Usage: compose-app-start <app-name>"
    echo "Available apps:"
    ls -d {{ .chezmoi.homeDir }}/.local/share/compose-apps/*/ 2>/dev/null | xargs -n1 basename | sort
    return 1
  fi

  local app_dir="{{ .chezmoi.homeDir }}/.local/share/compose-apps/$app_name"
  if [[ ! -d "$app_dir" ]]; then
    echo "Error: App '$app_name' not found in compose-apps directory"
    return 1
  fi

  cd "$app_dir"
  if docker compose ps --services --filter status=running | grep -q .; then
    echo "$app_name is already running"
  else
    echo "Starting $app_name..."
    docker compose up -d
  fi
  cd - > /dev/null
}

function compose-app-stop() {
  local app_name="$1"
  if [[ -z "$app_name" ]]; then
    echo "Usage: compose-app-stop <app-name>"
    echo "Running apps:"
    for dir in {{ .chezmoi.homeDir }}/.local/share/compose-apps/*/; do
      if [[ -d "$dir" ]]; then
        local name=$(basename "$dir")
        cd "$dir" 2>/dev/null && {
          if docker compose ps --services --filter status=running | grep -q .; then
            echo "  - $name"
          fi
          cd - > /dev/null
        }
      fi
    done
    return 1
  fi

  local app_dir="{{ .chezmoi.homeDir }}/.local/share/compose-apps/$app_name"
  if [[ ! -d "$app_dir" ]]; then
    echo "Error: App '$app_name' not found in compose-apps directory"
    return 1
  fi

  cd "$app_dir"
  echo "Stopping $app_name..."
  docker compose down
  cd - > /dev/null
}

function compose-app-status() {
  echo "Compose Apps Status:"
  for dir in {{ .chezmoi.homeDir }}/.local/share/compose-apps/*/; do
    if [[ -d "$dir" ]]; then
      local name=$(basename "$dir")
      cd "$dir" 2>/dev/null && {
        if docker compose ps --services --filter status=running | grep -q .; then
          echo "  ✓ $name (running)"
        else
          echo "  ✗ $name (stopped)"
        fi
        cd - > /dev/null
      }
    fi
  done
}

function compose-app-restart() {
  local app_name="$1"
  if [[ -z "$app_name" ]]; then
    echo "Usage: compose-app-restart <app-name>"
    return 1
  fi

  compose-app-stop "$app_name" && compose-app-start "$app_name"
}

function compose-app-logs() {
  local app_name="$1"
  if [[ -z "$app_name" ]]; then
    echo "Usage: compose-app-logs <app-name> [docker-compose-logs-options]"
    return 1
  fi

  local app_dir="{{ .chezmoi.homeDir }}/.local/share/compose-apps/$app_name"
  if [[ ! -d "$app_dir" ]]; then
    echo "Error: App '$app_name' not found in compose-apps directory"
    return 1
  fi

  shift
  cd "$app_dir"
  docker compose logs "$@"
  cd - > /dev/null
}

# Convenience aliases for specific apps
function openweb-ui-start() {
  compose-app-start openweb-ui
}

function openweb-ui-stop() {
  compose-app-stop openweb-ui
}

function openweb-ui-restart() {
  compose-app-restart openweb-ui
}

function openweb-ui-logs() {
  compose-app-logs openweb-ui "$@"
}

function openweb-ui-mcps() {
  local compose_file="{{ .chezmoi.homeDir }}/.local/share/compose-apps/openweb-ui/docker-compose.yml"

  if [[ ! -f "$compose_file" ]]; then
    echo "Error: docker-compose.yml not found for openweb-ui"
    return 1
  fi

  echo "OpenWebUI MCP Servers:"
  echo "----------------------"

  # Use yq to query all services starting with mcpo- and their ports
  local services=$(yq '.services | keys | .[] | select(. | startswith("mcpo-"))' "$compose_file")

  for service in $services; do
    # Get the first port mapping for this service (removing quotes)
    local port_mapping=$(yq ".services.\"$service\".ports[0]" "$compose_file" | tr -d '"')

    if [[ -n "$port_mapping" ]] && [[ "$port_mapping" != "null" ]]; then
      # Extract host port from the mapping (format: "8001:8000")
      local host_port=$(echo "$port_mapping" | cut -d: -f1)

      # Format service name for display
      local display_name=$(echo "$service" | sed 's/^mcpo-//' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

      printf "  • %-15s → localhost:%s\n" "$display_name" "$host_port"
    fi
  done

  echo ""
  echo "Access MCP OpenAPI docs at:"
  echo "  • http://localhost:<port>/docs"
}

function owlistic-start() {
  compose-app-start owlistic
}

function owlistic-stop() {
  compose-app-stop owlistic
}

function graphiti-mcp-start() {
  compose-app-start graphiti-mcp
}

function graphiti-mcp-stop() {
  compose-app-stop graphiti-mcp
}
