
# Enable dotfile globbing
setopt glob_dots

# Initialize completions (optimized)
autoload -Uz compinit
{{ if eq .chezmoi.os "darwin" -}}
if [[ -n ${ZDOTDIR}/.zcompdump(#qNmh+24) ]]; then
  compinit
else
  compinit -C
fi
{{ else -}}
# For Linux, use standard completion initialization
if [[ -n ~/.zcompdump(#qNmh+24) ]]; then
  compinit
else
  compinit -C
fi
{{ end -}}

# Add direnv hook
eval "$(direnv hook zsh)"

# Starship configuration
export STARSHIP_CONFIG="$HOME/.config/starship.toml"

# Set editor
export EDITOR=nvim
export VISUAL=nvim

# Add hishtory to PATH early (before it's used by other configurations)
export PATH="{{ .chezmoi.homeDir }}/.hishtory:$PATH"
export PATH="{{ .chezmoi.homeDir }}/.local/bin:$PATH"

# Load zgen/plugins early (before custom keybindings are defined)
if [ -f ~/.zgen/zgen.zsh ]; then
  source ~/.zgen/zgen.zsh
  if ! zgen saved; then
    zgen load 'wfxr/forgit'
    zgen save
  fi
fi

# Load language/tool specific configurations
{{ template "zsh/filesystem" . }}
{{ template "zsh/golang" . }}
{{ template "zsh/rust" . }}
{{ template "zsh/node" . }}
{{ template "zsh/python" . }}
{{ template "zsh/markdown" . }}
{{ template "zsh/docker" . }}

{{ template "zsh/shell" . }}

# Platform specific configurations
{{ if eq .chezmoi.os "darwin" -}}
{{ template "zsh/darwin" . }}
{{ template "zsh/tmux" . }}
{{ else if eq .chezmoi.os "linux" -}}
{{ template "zsh/linux" . }}
{{ template "zsh/compose" . }}
{{ template "zsh/ssh" . }}
{{ end -}}

# User specific aliases
{{ template "zsh/github" . }}
{{ template "zsh/devbox" . }}
{{ template "zsh/claude" . }}
{{ template "zsh/opencode" . }}
{{ template "zsh/bmm" . }}

# Load Doppler secrets
if [ -f {{ .chezmoi.homeDir }}/.config/doppler/env.sh ]; then
    source {{ .chezmoi.homeDir }}/.config/doppler/env.sh
fi

# Initialize devbox global environment
eval "$(devbox global shellenv)"

# Ensure hishtory Ctrl+R binding is active (re-bind after all templates load)
if [[ -f "{{ .chezmoi.homeDir }}/.hishtory/config.zsh" ]] && command -v hishtory &> /dev/null; then
  if [ "$(hishtory config-get enable-control-r)" = true ]; then
    bindkey '^R' _hishtory_widget
  fi
fi
