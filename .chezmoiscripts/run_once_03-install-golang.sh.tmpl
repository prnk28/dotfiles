#!/bin/bash
set -euo pipefail

GO_VERSION="{{ .versions.go | default "1.23.4" }}"

echo "Installing Go ${GO_VERSION}..."

# Check if Go is already installed and if it's the correct version
if command -v go &> /dev/null; then
    INSTALLED_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
    if [ "$INSTALLED_VERSION" = "$GO_VERSION" ]; then
        echo "Go ${GO_VERSION} is already installed"
        exit 0
    else
        echo "Updating Go from ${INSTALLED_VERSION} to ${GO_VERSION}"
    fi
fi

{{ if eq .chezmoi.os "linux" -}}
# Use goup for Linux installation
echo "Installing Go using goup..."

# Install goup if not present
if ! command -v goup &> /dev/null; then
    echo "Installing goup..."
    curl -sSf https://raw.githubusercontent.com/owenthereal/goup/master/install.sh | sh -s -- '--skip-prompt'
    
    # Add goup to current PATH for this script
    export PATH="{{ .chezmoi.homeDir }}/.go/bin:$PATH"
fi

# Install the specified Go version
goup install ${GO_VERSION}
goup set ${GO_VERSION}

echo "Go ${GO_VERSION} installed successfully using goup"

{{ else -}}
# Traditional installation for macOS
GO_INSTALL_DIR="/usr/local"

# Detect OS and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

# Convert architecture names
case "$ARCH" in
    x86_64)
        ARCH="amd64"
        ;;
    aarch64|arm64)
        ARCH="arm64"
        ;;
    *)
        echo "Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

# Construct download URL
GO_DOWNLOAD_URL="https://go.dev/dl/go${GO_VERSION}.${OS}-${ARCH}.tar.gz"

echo "Downloading Go for ${OS}-${ARCH}..."

# Download and install Go
cd /tmp
wget -q "$GO_DOWNLOAD_URL" -O "go${GO_VERSION}.tar.gz" || {
    echo "Failed to download Go. URL: $GO_DOWNLOAD_URL"
    exit 1
}

# On macOS, we might not have sudo access to /usr/local
if [ -w "$GO_INSTALL_DIR" ]; then
    rm -rf "${GO_INSTALL_DIR}/go"
    tar -C "$GO_INSTALL_DIR" -xzf "go${GO_VERSION}.tar.gz"
else
    sudo rm -rf "${GO_INSTALL_DIR}/go"
    sudo tar -C "$GO_INSTALL_DIR" -xzf "go${GO_VERSION}.tar.gz"
fi

rm "go${GO_VERSION}.tar.gz"

# Add Go to PATH in shell profile
# macOS uses .zprofile or .profile
PROFILE_FILE="{{ .chezmoi.homeDir }}/.zprofile"
if [ ! -f "$PROFILE_FILE" ]; then
    PROFILE_FILE="{{ .chezmoi.homeDir }}/.profile"
fi

# Add Go paths if not already there
if ! grep -q 'export PATH=$PATH:/usr/local/go/bin' "$PROFILE_FILE" 2>/dev/null; then
    echo 'export PATH=$PATH:/usr/local/go/bin' >> "$PROFILE_FILE"
fi

if ! grep -q 'export GOPATH=$HOME/go' "$PROFILE_FILE" 2>/dev/null; then
    echo 'export GOPATH=$HOME/go' >> "$PROFILE_FILE"
    echo 'export PATH=$PATH:$GOPATH/bin' >> "$PROFILE_FILE"
fi

echo "Go ${GO_VERSION} installed successfully"
echo "Please run 'source $PROFILE_FILE' or restart your shell"

# Source the profile to make Go available in current script
export PATH=$PATH:/usr/local/go/bin
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin

{{ end -}}
