#!/bin/bash
set -euo pipefail

echo "Installing Rust..."

# Check if Rust is already installed
if command -v rustc &> /dev/null; then
    echo "Rust is already installed (version: $(rustc --version))"
    echo "Run 'rustup update' to update Rust"
else
    # Install Rust using rustup (works on all platforms)
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    
    # Source cargo env
    source "{{ .chezmoi.homeDir }}/.cargo/env"
    
    echo "Rust installed successfully"
fi

# Ensure cargo is in PATH
export PATH="{{ .chezmoi.homeDir }}/.cargo/bin:$PATH"

# Install common Rust tools
if command -v cargo &> /dev/null; then
    echo "Installing common Rust tools..."
    
    # Install cargo-binstall first for faster subsequent installs
    if ! cargo install --list | grep -q "^cargo-binstall "; then
        echo "Installing cargo-binstall..."
        curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
    fi
    
    # Function to install a cargo tool
    install_cargo_tool() {
        local tool="$1"
        local use_locked="${2:-false}"
        
        if ! cargo install --list | grep -q "^$tool "; then
            echo "Installing $tool..."
            
            # Tools that need --locked flag must use cargo install
            if [ "$use_locked" = "true" ]; then
                cargo install --locked "$tool"
            elif command -v cargo-binstall &> /dev/null; then
                cargo binstall -y "$tool" || cargo install "$tool"
            else
                cargo install "$tool"
            fi
        else
            echo "$tool is already installed"
        fi
    }
    
    # Install tools without special flags
    for tool in bat eza fd-find ripgrep zoxide starship cargo-edit cargo-watch cargo-audit cargo-outdated cargo-expand; do
        install_cargo_tool "$tool" "false"
    done
    
    # Install yazi with --locked flag
    install_cargo_tool "yazi-fm" "true"
    install_cargo_tool "yazi-cli" "true"
fi

echo "Rust setup complete"
