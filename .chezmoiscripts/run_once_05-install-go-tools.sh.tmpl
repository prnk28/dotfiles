#!/bin/bash
set -euo pipefail

# Ensure Go is in PATH
{{ if eq .chezmoi.os "linux" -}}
# Use goup paths for Linux
export PATH="{{ .chezmoi.homeDir }}/.go/bin:{{ .chezmoi.homeDir }}/.go/current/bin:$HOME/go/bin:$PATH"
{{ else -}}
# Traditional paths for macOS
export PATH=$PATH:/opt/homebrew/bin:/usr/local/bin:$HOME/go/bin
{{ end -}}

if command -v go &> /dev/null; then
    echo "Installing Go tools..."
    
    go_tools=(
        "github.com/charmbracelet/glow@latest"           # Markdown renderer
        "github.com/golangci/golangci-lint/cmd/golangci-lint@latest"  # Go linter
        "github.com/x-motemen/ghq@latest"                # Git repository manager
        "github.com/euforic/todos@latest"
        "github.com/nametake/golangci-lint-langserver@latest"
        "github.com/m7medvision/lazycommit@latest"       # AI-powered commit messages for lazygit
        "github.com/mgechev/revive@latest"               # Fast Go linter
        "golang.org/x/tools/gopls@latest"                # Go language server
        "golang.org/x/tools/cmd/goimports@latest"        # Go imports formatter
        "github.com/go-delve/delve/cmd/dlv@latest"       # Go debugger
        "honnef.co/go/tools/cmd/staticcheck@latest"      # Go static analyzer
        "github.com/fatih/gomodifytags@latest"           # Go struct tag modifier
        "github.com/josharian/impl@latest"               # Go interface implementation generator
        "mvdan.cc/gofumpt@latest"                        # Stricter gofmt
    )
    
    # Conditional tools - only install if not available via package manager
    conditional_tools=(
        "github.com/junegunn/fzf@latest"                 # Fuzzy finder (available via apt on Linux)
        "github.com/jesseduffield/lazydocker@latest"     # Docker TUI (not in standard apt)
        "github.com/mikefarah/yq/v4@latest"              # YAML processor (complex apt setup)
    )
    
    # Install standard Go tools
    for tool in "${go_tools[@]}"; do
        tool_name=$(basename "$tool" | cut -d'@' -f1)
        echo "Installing $tool_name..."
        go install "$tool"
    done
    
    # Install conditional tools only if not already available
    for tool in "${conditional_tools[@]}"; do
        tool_name=$(basename "$tool" | cut -d'@' -f1)
        if ! command -v "$tool_name" &> /dev/null; then
            echo "Installing $tool_name (not found via package manager)..."
            go install "$tool"
        else
            echo "$tool_name already available via package manager, skipping Go install"
        fi
    done
    
    echo "Go tools installed successfully"

    # Create symlinks for Go tools in ~/.local/bin for better PATH compatibility
    mkdir -p {{ .chezmoi.homeDir }}/.local/bin
    if [ -f {{ .chezmoi.homeDir }}/.go/bin/lazycommit ]; then
        ln -sf {{ .chezmoi.homeDir }}/.go/bin/lazycommit {{ .chezmoi.homeDir }}/.local/bin/lazycommit
        echo "Created lazycommit symlink in ~/.local/bin"
    fi
else
    echo "Go is not installed. Skipping Go tools installation."
fi

