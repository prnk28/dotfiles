#!/bin/bash
# {{ include ".chezmoitemplates/tmux/plugins.conf" | sha256sum }}
set -euo pipefail

echo "🔌 Managing tmux plugins with TPM..."

TPM_DIR="{{ .chezmoi.homeDir }}/.tmux/plugins/tpm"

# Install TPM if not present
if [ ! -d "$TPM_DIR" ]; then
    echo "📥 Installing TPM (Tmux Plugin Manager)..."
    mkdir -p "$(dirname "$TPM_DIR")"
    git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
    echo "✅ TPM installed successfully"
else
    echo "✅ TPM is already installed"
fi

# Check if TPM scripts exist
if [ ! -f "$TPM_DIR/bin/install_plugins" ]; then
    echo "❌ TPM install script not found at $TPM_DIR/bin/install_plugins"
    exit 1
fi

echo "📦 Installing/updating tmux plugins..."

# Clean plugins first (remove plugins no longer in the list)
if [ -f "$TPM_DIR/bin/clean_plugins" ]; then
    echo "🧹 Cleaning unused plugins..."
    "$TPM_DIR/bin/clean_plugins" || true
fi

# Install new plugins
echo "📥 Installing plugins..."
"$TPM_DIR/bin/install_plugins"

# Update existing plugins
if [ -f "$TPM_DIR/bin/update_plugins" ]; then
    echo "🔄 Updating plugins..."
    # Use 'all' flag to update all plugins non-interactively
    echo "all" | "$TPM_DIR/bin/update_plugins" || true
fi

echo "✅ Tmux plugins installation complete!"

